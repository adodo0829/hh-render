# 关键技术点

后端层面见：0.tes
前端层面：

## webgl 2D 可视化

`pixijs` 渲染引擎

# 实时监控设计

地图展示区: 你可以在这里看到仓库设备区域的整体规划布局,设备信息,容器信息,交通路况。

监控工具栏
路障设置：设置禁止通行路障,禁止载物通行路障
地图调整: 调整地图偏移量,贴近真实场景
放大缩小: 放大缩小地图视角
图例说明: 对地图元素进行说明,包括设备,点,线
全屏展示: 全屏展示监控画面,更大更方便
清除索引: 可支持批量清除索引功能、
地图旋转：支持将地图进行旋转 90°、180°、270°

对象操作栏: 选中设备或容器或地图元素时会展示出对象操作栏

对象搜索框：可以根据搜索对象的类型及编号等搜索对象，如设备，容器，任务，位置，站点，区域

设备统计区：根据库区名称和设备类型统计不同状态的设备数量，且可以点击的数字查看相应状态的设备明细。
全局设备操作：可以针对单个库区内的某个设备类型执行批量操作。
信息展示区域：此处可以展示选中的设备的详细信息和关联的任务信息。

## 地图架构设计

## 渲染层

渲染器只是做一件事: 那就是根据设计的逻辑进行元素渲染
所以我们设计的核心: 数据模型的设计才是本质
数据结构体定义
数据转换
数据操作

- 静态渲染
  采用图层架构模式
  对业务地图元素进行分类，划分到不同图层
  点，边，设备，辅助图层（弹框，气泡，高亮，路线等等）

- 动态渲染
  设备实时动画
  开启动画循环进行实时绘制

实时动画是一个比较消耗硬件资源(CPU&GPU)的功能点, 需要维持一个持续渲染的状态, 1s 绘制大概 60 次, 也就是在 16ms 内 需要完成 设备属性(最新位置,方向)的计算, 并添加到缓冲区进行渲染;
这里可以先做一个优化, 只有增量数据推送了 设备位置信息时 (increase 模式下, move 对象的 device 有数据), 我们才开启 逐帧渲染模式, 没有数据时关闭逐帧渲染. 做到按需开启, 故可以引入一个操作模式: 逐帧渲染模式

增量推送的 时间点
增量推送的 设备位置,方向

## 数据层

- 静态数据 （静态业务点）
  http 获取
- 动态数据（设备 和 容器， 索引点）
  mqtt 推送

## 事件交互层

点选，拖拽，缩放，框选等

## 动画（时间控制器）

- 渲染策略 1:
  只要推送了设备移动数据, 我们就全量更新设备最新的位置数据, 没考虑时间问题; 丢失`平滑移动`的效果

如果加上时间轴动画平滑小改改, 渲染策略也需要发生改变

- 渲染策略 2：

首先, 因为要做动画, 必然会消耗时间, 那么 server 推送的数据肯定是无法及时渲染的, 必然会导致延迟, 就像直播一样, 中间的采集和转化也需要时间来处理, 会有一定延迟;

其次, server 不会考虑我们的动画要花费的时间, 肯定是不断给前端推 server 时间轴的数据 (某个时刻, 设备的位置), 而此时前端正在做上一个时刻的 动画, 所以这些对前端时间轴来说属于 未来时刻的位置, 前端肯定不能随便丢弃这些数据, 所以每个设备需要新增一个 `动画帧数据队列` 来维护这些数据, 做完动画再删除这些数据;

并且还要根据 现实时间 判断 目前维护的运动数据 是否是过期, 过期的数据还需要进行删除, 不然会一直占用内存

给动态设备数据绑定一个 `动画队列字段 frameQueue`， 将后端推送的小车到达的位置存储起来，然后按帧绘制，绘制完后进行清除
