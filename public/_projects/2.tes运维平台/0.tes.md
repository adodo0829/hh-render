# 调度执行系统 Task Execution System

它面向仓储物流和工业搬运等行业，提供的是点到点搬运的解决方案。
上层系统只需要决策从哪到哪，调度执行系统通过调度策略和算法赋能，会将点到点搬运做到效率极致。

任务调度，本质解决的是 仓库容器搬到 到哪里的问题;

## 1.场景管理

地图、容器和设备是自动化仓储的三大重要角色，系统也是以这三大角色为基础，进行场景化的搭建与调度

### 地图

地图是仓库物理设施的抽象描述。河图系统若要进行设备调度，地图是非常重要的前置依赖。
系统通过感知设备（和容器）在地图上的相对位置关系，来进行最合理的调度。
另一方面，地图也用来描述业务规划，例如存储区和工作站的相对位置关系，以及其他组件等等。
可以通过河图构建工具来绘制一个地图，绘制完成后可以导出一个地图文件

### 容器

容器（Pod）是能够承载物料，或其他更小容器的物理装置。容器有多种形态，统称为 POD。系统支持多种规格的容器管理

托盘：agv
托盘支架：agv
货架：agv
物料箱：ctu 叉车，输送线设备

### 设备

设备指仓库内辅助作业的自动化设备，有很多种类，不同设备的作业能力，作业对象不同。
系统以四向车立库与工厂搬运的业务场景为基础，接入并控制了主要的自动化设备，主要设备能力如下

- 四向穿梭机器人
  可以四个方向穿行，行驶在货架轨道上，在提升机的配合下实现跨楼层搬运。适用于立体库场景。
  搬运对象一般以托盘为载体
  通讯方式：TCP/IP

- 二维码导航的 AGV
  需要通过地标二维码进行定位。适用于货到人、工场搬运、仓库搬运等场景
  可以与机械臂、四向车等设备进行组合作业
  搬运对像一般为货架、托盘、工场原料等
  通讯方式：TCP/IP

- 激光导航（slam） AGV
  区别于二维码导航，行走，导航不依赖于二维码，使用起来更灵活，适用场景更全面
  可以与机械臂、四向车等设备进行组合作业
  搬运对像一般为货架、托盘、工场原料等
  通讯方式：TCP/IP

- 托盘输送机
  主要功能为托盘输送。也可以在线体上集成外形检测、缠膜机、旋转机、拆叠盘机等模块，完成对应的功能。
  搬运对象一般以托盘为载体
  通讯方式：PLC

- 拆盘机，叠盘机，
  支持空托回收，自动拆盘
  作业对像为空托盘和托盘垛
  PLC

- 提升机
  配合四向穿梭车，实现货物的跨楼层搬运，可以只搬运货物，也可以连带四向穿梭车一起跨楼层搬运
  ModBus

- 光电设备
  光电检测信号接入，检测托盘上下架的状态变更，多用于出入口库配合人工上下架处理

- 自动门
  开关控制，以及 AGV 和四向车在自动门的穿行控制
  适用于多库区隔离等场景，默认关闭，车量通行进系统空开关

## 2.任务调度

- 任务的定义
  任务（Task）是一种执行过程抽象，通过执行 Task 改变目标对象的物理状态（该物理状态指目标对象某时刻的位姿、朝向、本体电量、结合方式等）。

  容器搬运任务（ MovePodTask ）是最常见的任务，通过执行该任务能够改变容器的位置。

仓库业务系统若要持续运转，就需要将大批容器搬运到指定地方作业，或搬运到储位存储来完成业务场景。
而这么多的任务，按什么顺序执行、怎么执行才会效率最高，这是任务调度处理的核心问题。
系统内置了大量的任务调度策略，通过策略驱动与算法赋能，不仅能满足业务场景要求，还能极大提升任务的执行效率。

### 任务调度策略

1.任务优先级
在一些业务场景中，有任务需要优先执行的要求。通过给任务标记优先级后，系统在进行任务调度时，优先执行优先级高的任务

2.任务依赖
系统在进行任务调度时，会根据任务容器位置自动计算依赖关系，并且合理的控制任务执行顺序，保障有依赖关系的任务可以正常执行搬运

3.批次任务
在一些业务场景中，有按批出货到指定区域的需求（例如同一个客户的商品需要一起装货），系统在进行任务调度时，会根据任务标记的批次信息统一进行分组，优先执行同一批次的任务。

4.保序任务
在一些业务场景中，容器需要按照严格的顺序到站点作业（工艺组装搬运时，要求部件必须按照顺序到达产线），系统在进行任务调度时，会根据任务标记的序号信息进行逐一执行，严格保障容器的到站顺序。

### 任务执行过程

一个 Task 的执行需要多个设备协同完成，需要拆解成若干 Step

### 任务分类

搬运，移动，充电，备车，保序
任务级的操作，包含任务重试，任务强制完成，任务取消，调整优先级等

## 3.设备调度

自化动仓库在完成场景作业过程中，需要有众多的设备协同作业，而设备调度的核心就是决策和控制不同的设备作最合适的工作。
比如决策小车是去搬运容器还是去休息，或者应该去充电。
系统内置了大量的设备调度策略，通过策略决策，再结合任务与站点的情况，合理化的对设备进行调度控制。

运力分配策略
合理解决运力资源与任务的关系匹配，让最优的车去执行最应该做的任务。让任务执行效率最优化。

充电策略
提升小车的续航能力，保障业务不间断作业，合理处理充电与搬运间的关系。

休息区策略
非作业时间段，让小车去合适的地方泊车，为下一次的任务潮汐做准备。

提前调度策略
接货设备提前调度，真正实现车等货，搬运效率最大化。

密集搬运策略
上游系统密集管理简洁化，阻碍管理与依赖搬运自闭环

## 4.站点调度

A、在人工作业环境中，站点是指人机交互作业的位置，通常是操作员需要进行业务操作的工位。
B、在跨系统的设备进行协同作业场景中，站点是指设备进行容器交接的位置，通常是指一个系统的设备把容器放到指定的工位，另一个系统来此工位进行取货作业。

站点调度解决的是任务与站点的选择关系，让任务选择最优的站点进行作业。
系统通过一系列的站点策略与算法赋能，在满足业务需求的同时，保障最优的搬运效率和最好的作业节奏。

### 群体决策

从站点的角度出发，支持根据站点类型，灵活配置策略，决定站点与任务之间的关系，适配各种业务场

站点均衡，缓存，叫号，限流，保序

### 外部接驳

系统对于站点提供了一整套的外部交互方案，用于在大型集成项目中，和其厂商设备系统进行货物接驳控制

预占、占用、释放

## 5.寻路与导航

将一个货物从 A 点搬运到 B 点，系统需要经过子图寻路与导航规划两个步骤：

子图寻路：解决的是选择什么样的搬运方式。类似于从北京到上海，是选择坐火车还是坐飞机。
导航规划：解决的是柔性搬运设备的搬运路径。类似于选择坐飞机去上海，从家到机场打车，小车按什么样的路径走。

### 跨子图寻路

在多层四向穿梭车立体库中，每一层都是一个子图，每个提升机也是单独的子图。
如果一个任务的起点和终点不在同一层，在寻路时就需要经过 起始子图 》》提升机子图 》》目标子图

出现多种设备子图，并且容器需要进行多设备搬运时，系统会根据子图路网结构以及设备情况进行跨子图寻路，生成最优搬运路径。主要核心策略：
冲突检测：当子图间需要双向搬运时，针对接驳点进行冲突检测，防止接驳点卡死造成任务死锁，
流量均衡：当跨子图搬运有多条通路可达时，系统根据各子图任务和设备情况选择进行搬运流量的均衡匹配，防止任务集中在单个接驳节点上进行造成拥堵
死锁解除：跨子图搬运在运力不足等极端情况下会有可能会出现死锁的情况（概率极低），系统可以针对死锁进行处理解除

### 导航规划

导航就是让机器人可以自主按照内部预定的信息，或者依据传感器获取外部环境进行相应的引导，从而规划出一条适合机器人在环境中行走的路径。

小车从始点到目标点，具体要怎么走，会根据现实环境的真实情况和系统的导航策略，规划出一条最优的路径，生成相关的指令协议控制设备按照规划路径运动。

路径预占

系统为了让设备以最小成本完成搬运，实现了一系列的相关策略，主要核心策略如下表

多车混跑
同一类别不同型号的车在同一物理环境中进行协同调度作业，系统根据车型和导航策略合理占用路径资源。

动态热力图 系统通过对设备运行状态的计算，来确定某一个区域的热力，从而实现动态创建热力图，减少区域拥堵和避障发生的概率。系统每 2 秒计算一次，热力为每个小车的接下来路径随时间推移的动态热力，按指数衰减。

立体多边形检测
导航通过多边形检测策略，决策路径资源是否会发生冲突，从而合理规划路径。

系统提供了立体多边形检测的机制，当载货小车空载小车进行检测时，以上层货架范围计算是有冲突的，可是以下层小车与小车的范围进行计算，是可以并行的。

拥堵解环
系统可以判断多个被堵塞(成环)设备间的依赖关系，从外向内指定可避让位置，进行解环，解环后支持任意设备不再被堵塞，继续各自任务；

提前避让
在路况不复杂的情况下，系统可以调度提前避让，如果遇到拥堵的情况，不会进行提前避让。

空车优先走货架区
导航决策空车尽量走货架区，从而减少跟满载的车抢路的可能性，减少拥堵压力和避障风险。

满载车优先走主通路 除了起点和终点，满载的车优先走主通路，避免在货架区穿行时由于环境因素（异常货物）造成异常。

空巷道载货穿行 在特殊情况下，满载小车也可以从空巷道穿行，例如从主通路走需要绕行，搬运成本高时。

自动门穿行
小车需要穿行自动门时，导航决策支持提前打开自动门，小车不停直接穿行。

导航决策也支持一次开门多辆车排队依次通过，解决排队过自动门多次开关门的情况。

消防联动
系统与消防系统对接进行消防联动，消防信号触发时，导航决策全场停车，并且控制小车不停在消防门下方。

交通管制
交通管制区是指多个点组成的区域，比如叉车要使用某个区域，上游系统调用 API 设置交通管制区，当前交通管制区的设备会移动出来，其他车的任务将不下发此区域任务，清场后，异步通知上游条件具备，可以进行特殊任务。

故障绕行
系统在规划路径的时候，可以绕开故障车辆，离线车辆，以及有任务暂停的车辆，减少避障。

临时禁行点
因为环境情况路径不可达时（路面问题、货架问题等），可将此路段禁行，导航决策小车进行绕行。

临时禁行点，分为两种，一种是小车不可通行，另一种，空车可以通行，载货架不可通行。可以通过地图操作设置临时进行点，达到配合现场业务规划的目的。

避开站点
有其他路线情况下会避开非终点的站点，优先走其它路径，避免与站点作业小车产生拥堵。

自主选择可旋转点
系统根据设备运力情况以及路网结构，在移动过程中，动态选择旋转点进行旋转换面。

## 6.异常处理机制

在系统调度和设备运行过程中，会因为一些环境等其它因素产生各种异常，系统有一系列的异常恢复和处理机制，可以业务稳定运行。

安全区封锁
当触发安全区封锁时，安全区内的小车全部暂停，外部小车进行绕行

高温去安全岛
系统自动检测小车电池温度，当电池温度高于警戒线时，系统进行告警。
高温小车在临近储位将托盘放下后，行驶进防火安全岛进行紧急处理。

拥堵决策切换站点
任务执行过程中，当路径中的过程站点出现拥堵或者禁用等异常时，系统进二次决策，切换其它正常路径进行搬运。

自动换车
小车在取托盘途中故障，系统会自动派另一辆车来做任务
小车在托盘下，或扛起托盘后故障，则不会换车
