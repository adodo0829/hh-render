# 关键技术点

亮点功能：业务功能 抽离成 低代码模式，降本增效

前端表现层 主要以报表，大屏类业务为主，系统 80% 都是报表查询类逻辑

后端层 主要是以入库，出库，盘点等业务流程为主

面向定制化交付类业务如何做到提效？

前提背景，客户需求差异化，
需要快速交付； 我们把公共通用业务低代码化，减少定制化开发的成本；

所有就有了 自定义报表，打印模版编辑器，大屏设计器，业务流程编排等功能

## 自定义报表生成器

背景：由于定制化项目客户要求可能各部相同，同一个标准品的页面, a 客户需要查询的字段是 3 个，b 客户是 2 个；

基于此背景，将需要前端定制化开发的一些场景抽象为可复用的产品功能，降低后续前端层面的开发成本；
比如 crud 报表页面，我们做成直接根据配置生成，新增的报表查询页面 不需要手动写代码；

报表页面的结构特性：
UI 层： 1.查询表单 2.表格展示 3.自定义业务逻辑封装嵌入

事件交互层：
点击表单查询，表格接受参数提交接口进行查询

设计实现： 1.报表页面配置 （数据字段配置来源， sql 语句）

- 根据 SQL 语句获取所有的配置字段
- 对字段进行业务分类，主要分为两大类
  ---- 查询表单
  -------- 定义字段表单类型（input，select，timepicker 等）
  -------- 如果是 select 还需要配置下拉数据源等
  -------- 如果是 input，是模糊搜索，还是精确搜索等
  ---- 表格展示
  -------- 定义字段业务逻辑（是否合计）

  2.配置完成后，落库； 如果需要在系统里渲染；则需要发布到指定的菜单下面，且配置权限
  初始化系统的时候，生成动态路由插入到前端路由表里

  3.配置渲染
  开发一个独立组件： 负责读取配置 =》 解析表单和表格各字段属性 =》传入到组件
  然后生成表单组件 和 表格组件
  QueryForm =》 initPageForm
  QueryTable =》 initPageTable
  =》 组成 queryPage

## 流程编排

将实际业务流程中每一个后端功能节点进行模块化，通过对同一业务各功能节点的自由组合，定制出一个特殊的业务流程，
用来满足不同行业/客户的不同业务流程需求，

在一定程度上减少项目实施过程的定制开发，降低开发成本，提高项目实施效率。

流程逻辑编排的目的，是用最少甚至不用代码来实现软件的业务逻辑，包括前端业务逻辑跟后端业务逻辑

### 业务流程-节点组成

- 入库流程业务功能节点
  入库单创建，收货，质检，组盘，自动化库分配货位，非自动化库分配货位，上架

- 出库流程业务功能节点
  出库单创建，生成波次，分配库存，是否自动拣选（自动拣货， 人工拣选），出库确认（集货复核）

- 盘点流程
  盘点单， 开始盘点，盘点结果，复盘，损益处理

- 库内流程
  容器移位
  理货，
  补货，

### 前端实现

将需要后端定制化开发的一些场景转换为 通过前端节点的组合来完成，降低后期后端层面的开发成本；
只需要在前端流程图组装 业务功能节点， 就可以在后台生成一条任务执行流水线；执行流程上逻辑编排

需要将业务流程中每一个功能节点进行高度抽象模块化，通过对同一业务各功能节点的自由组合，定制一个特殊的业务流程；
目的是 把后端的业务流程执行逻辑代码块 放在 前端自由排列组合； 降低项目定制化开发成本；

流程图组成结构：节点 + 边
支持逻辑结构：顺序结构， 分支结构

UI 和产品设计不适用编辑器拖拽映射，从上往下，左往右平铺的方式

- 节点数据建模

- 边数据建模

## 打印模版编辑器

需求背景：
项目交付中经常会碰到各种单据打印需求，箱码，条码等 贴在纸箱和周转箱上这种业务，且每个客户提供打印模版不太一样，所有每个项目都定制化开发，

为了解决这个问题就开发了这个打印模版编辑器，提高人效，并支持个性化自定义模版，满足 90%以上的需求

- 主动触发的打印
- 自动打印(依赖 exe 程序)

大概梳理下目前需要实现的核心功能点（重难点）
1.DOM 元素 拖拽控制
2.DOM 元素 结构控制（增删改）
3.JSON 结构解析和编译 HTML《=》JSON 互转  
4.打印文档生成， 适配打印机  
5.编辑器交互操作设计 （事件系统）  
6.打印方案动态挂载到目标页面

被控制的元素物料：文字，图片，表格，二维码，条形码，基础图形（线，矩形，圆），字段列

### 架构设计

由于打印的元素类型 和 渲染数量并不多

直接基于 DOM 实现，主要是封装组件，以功能实现为主

MVC 模式
编辑物料准备区（业务元素），编辑控制状态（业务控件区）， 元素面板信息展示区

代码实现： 物料单元数组 + 动态组件渲染

生成一个打印配置文件， 在哪应用呢？ 从报表页面 取数， 对模版进行填充

### 难点

1.实现方案采用：
web 端无感知打印 + 打印机静默打印
web 端采用 iframe，静默打印开发一个本地应用程序来实现

2.打印内容分页处理
当打印模版里存在 table 时，
表格元素数据填充后长度是不定长的，我们的纸张尺寸是定宽高的，需要做各种场景做处理

3.表格实体模型的设计：需要支持合并单元格 和 拆分单元格，插入行，插入列

选中单元格的实现：
mousedown 选中 + mouseover（为什么没有用 mousemove 适合拖拽交互）+ mouseup 离开此次交互；
`mouseenter：当鼠标指针进入元素边界时触发，与 mouseover 不同的是，它不会冒泡，且不会在子元素上触发`
mouseover 的过程中给单元格添加 selected 标识

4.表格设计建模

```js
// 表格是有行，列特征；我们直接用一个 二维矩阵模型来表示表格的结构
// 普通单元格设置为0，
// 表格自带合并属性 rowSpan colSpan

// 合并后会形成一个大单元格
// 合并的起始格定位-负数开头，被合并的格子定为取反，这样就是一组单元格

// 收集所有合并的单元格
// 拆封单元格， 获取开始的单元格，重写二维矩阵，重新生成表格
```

## 自定义大屏设计器

代码实现： 物料单元数组 + 动态组件渲染

拖拽生成布局信息；

物料属性面板配置物料展形式 和 数据来源等

解析编辑存储的配置文件，渲染出来

### 编辑的元素（物料）

布局模版，画布模版；
各类图形，echarts 图形单元封装
文字（跑马灯），表格；
视频，图标，图片；
个性化装饰素材；

数据模型定义 + 属性编辑

物料单元数组 + 动态组件渲染
